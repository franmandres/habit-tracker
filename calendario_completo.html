
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Calendario de Actividades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Navbar -->
    <div class="bg-blue-600 text-white p-4 flex justify-between items-center navbar">
        <div class="flex items-center">
            <button onclick="changeMonth(-1)" class="mr-4 p-2 rounded bg-blue-500 hover:bg-blue-400">←</button>
            <h1 id="month-title" class="text-xl font-semibold"></h1>
            <button onclick="changeMonth(1)" class="ml-4 p-2 rounded bg-blue-500 hover:bg-blue-400">→</button>
        </div>
        <div>
            <span id="current-date" class="text-lg"></span>
        </div>
    </div>

    <!-- Sticky Button -->
    <div class="p-4 sticky-btn-container">
        <button onclick="toggleView()" class="bg-green-500 text-white p-2 rounded">Ver Resumen Mensual</button>
    </div>

    <!-- Vista calendario -->
    <div id="calendar-view" class="p-4">
        <div id="calendar" class="grid grid-cols-7 gap-2">
            <div class="header-day p-2 text-center">Lunes</div>
            <div class="header-day p-2 text-center">Martes</div>
            <div class="header-day p-2 text-center">Miércoles</div>
            <div class="header-day p-2 text-center">Jueves</div>
            <div class="header-day p-2 text-center">Viernes</div>
            <div class="header-day p-2 text-center">Sábado</div>
            <div class="header-day p-2 text-center">Domingo</div>
        </div>
        <div id="calendar-days" class="grid grid-cols-7 gap-2"></div>
    </div>

    <!-- Vista resumen -->
    <div id="summary-view" class="p-4 hidden">
        <h2 class="text-2xl mb-4">Resumen de Actividades</h2>
        <canvas id="activityChart" height="200" class="my-6 bg-white rounded shadow p-4"></canvas>
        <div id="summary-activities"></div>
    </div>

    <!-- Scripts -->
    <script>
        let currentDate = new Date();
        let data = JSON.parse(localStorage.getItem('calendarData')) || {};
        let currentView = 'calendar';
        const sportsList = ["Fuerza", "Padel", "Spinning", "Running"];

        function saveData() {
            localStorage.setItem('calendarData', JSON.stringify(data));
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            updateCalendar();
        }

        function getDateKey(year, month, day) {
            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        function getMonthName(monthIndex) {
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            return months[monthIndex];
        }

        function getDayName(dayIndex) {
            const days = ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"];
            return days[dayIndex];
        }

        function updateCalendar() {
            let month = currentDate.getMonth();
            let year = currentDate.getFullYear();
            document.getElementById('month-title').innerText = `${getMonthName(month)} ${year}`;
            document.getElementById('current-date').innerText = `${getDayName(currentDate.getDay())} ${currentDate.getDate()} de ${getMonthName(month)} ${year}`;

            let firstDay = (new Date(year, month, 1).getDay() + 6) % 7;
            let lastDate = new Date(year, month + 1, 0).getDate();
            let daysHTML = '';
            let todayIndex = currentDate.getDate();

            for (let i = 0; i < 42; i++) {
                let dayNumber = i - firstDay + 1;
                if (dayNumber > 0 && dayNumber <= lastDate) {
                    let dateKey = getDateKey(year, month + 1, dayNumber);
                    let isToday = (new Date()).toDateString() === new Date(year, month, dayNumber).toDateString();
                    let checkedData = data[dateKey] || {};
                    daysHTML += `<div class="p-2 ${isToday ? 'current-day' : ''} bg-white border rounded">
                        <span class="block text-center font-semibold">${getDayName((i + 1) % 7)} ${dayNumber}</span>
                        <div class="space-y-1 mt-2">
                            <label><input type="checkbox" ${checkedData.exercise ? 'checked' : ''} onchange="toggleActivity(${dayNumber}, 'exercise')" class="mr-1">Ejercicio</label>
                            <label><input type="checkbox" ${checkedData.creatine ? 'checked' : ''} onchange="toggleActivity(${dayNumber}, 'creatine')" class="mr-1">Creatina</label>
                            <label><input type="checkbox" ${checkedData.steps ? 'checked' : ''} onchange="toggleActivity(${dayNumber}, 'steps')" class="mr-1">Meta pasos</label>
                            <select class="sport-selector" onchange="addSport(${dayNumber}, this)">
                                <option value="">Añadir deporte</option>
                                ${sportsList.map(sport => `<option value="${sport}">${sport}</option>`).join('')}
                            </select>
                            ${checkedData.sportsDetails ? renderSports(checkedData.sportsDetails, dayNumber) : ''}
                        </div>
                    </div>`;
                } else {
                    daysHTML += '<div class="p-2"></div>';
                }
            }

            document.getElementById('calendar-days').innerHTML = daysHTML;
        }
    </script>
</body>
</html>

        function getDayName(dayIndex) {
            const days = ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"];
            return days[dayIndex];
        }

        function toggleActivity(dayNumber, activityType) {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;
            const dateKey = getDateKey(year, month, dayNumber);
            if (!data[dateKey]) data[dateKey] = {};
            data[dateKey][activityType] = !data[dateKey][activityType];
            saveData();
            updateCalendar();
        }

        function addSport(dayNumber, selectElement) {
            const sport = selectElement.value;
            if (!sport) return;

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;
            const dateKey = getDateKey(year, month, dayNumber);

            if (!data[dateKey]) data[dateKey] = {};
            if (!data[dateKey].sportsDetails) data[dateKey].sportsDetails = [];

            const sportDetail = { type: sport };

            if (sport === "Fuerza") {
                sportDetail.group = "Pecho/Tríceps";
            }

            if (sport === "Running") {
                sportDetail.pace = "";
                sportDetail.km = "";
            }

            data[dateKey].sportsDetails.push(sportDetail);
            saveData();
            updateCalendar();
        }

        function renderSports(sportsDetails, dayNumber) {
            return sportsDetails.map((sport, index) => {
                let extraInputs = '';
                if (sport.type === "Fuerza") {
                    extraInputs = `
                        <select onchange="updateFuerzaGroup(${dayNumber}, ${index}, this)" class="mt-1 w-full border rounded">
                            <option value="Pecho/Tríceps" ${sport.group === "Pecho/Tríceps" ? 'selected' : ''}>Pecho/Tríceps</option>
                            <option value="Espalda/Bíceps" ${sport.group === "Espalda/Bíceps" ? 'selected' : ''}>Espalda/Bíceps</option>
                            <option value="Hombro/Abdominales" ${sport.group === "Hombro/Abdominales" ? 'selected' : ''}>Hombro/Abdominales</option>
                            <option value="Otro" ${sport.group === "Otro" ? 'selected' : ''}>Otro</option>
                        </select>`;
                }
                if (sport.type === "Running") {
                    extraInputs = `
                        <input type="text" placeholder="Ritmo (min/km)" class="mt-1 w-full border rounded" value="${sport.pace}" oninput="updateRunning(${dayNumber}, ${index}, 'pace', this)">
                        <input type="number" step="0.01" placeholder="Kilómetros" class="mt-1 w-full border rounded" value="${sport.km}" oninput="updateRunning(${dayNumber}, ${index}, 'km', this)">`;
                }
                return `<div class="mt-2">
                    <span class="sport-badge" onclick="removeSport(${dayNumber}, ${index})">${sport.type} ✕</span>
                    ${extraInputs}
                </div>`;
            }).join('');
        }

        function updateFuerzaGroup(dayNumber, index, selectElement) {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;
            const dateKey = getDateKey(year, month, dayNumber);
            data[dateKey].sportsDetails[index].group = selectElement.value;
            saveData();
        }

        function updateRunning(dayNumber, index, field, input) {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;
            const dateKey = getDateKey(year, month, dayNumber);
            data[dateKey].sportsDetails[index][field] = input.value;
            saveData();
        }

        function removeSport(dayNumber, index) {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;
            const dateKey = getDateKey(year, month, dayNumber);
            data[dateKey].sportsDetails.splice(index, 1);
            saveData();
            updateCalendar();
        }

        function toggleView() {
            const calendarView = document.getElementById('calendar-view');
            const summaryView = document.getElementById('summary-view');

            if (currentView === 'calendar') {
                currentView = 'summary';
                calendarView.style.display = 'none';
                summaryView.style.display = 'block';
                showSummary();
            } else {
                currentView = 'calendar';
                summaryView.style.display = 'none';
                calendarView.style.display = 'block';
            }
        }

        function showSummary() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;
            const totalDays = new Date(year, month, 0).getDate();

            let totalExercise = 0, totalCreatine = 0, totalSteps = 0, daysRecorded = 0;
            let meals = { Perfecto: 0, Bien: 0, Normal: 0, Mal: 0 };
            let fuerzaGroups = { "Pecho/Tríceps": 0, "Espalda/Bíceps": 0, "Hombro/Abdominales": 0, "Otro": 0 };
            let totalRunningKm = 0, runningPaces = [];

            for (let day = 1; day <= totalDays; day++) {
                const dateKey = getDateKey(year, month, day);
                const entry = data[dateKey];
                if (!entry) continue;
                daysRecorded++;
                if (entry.exercise) totalExercise++;
                if (entry.creatine) totalCreatine++;
                if (entry.steps) totalSteps++;
                if (entry.food) meals[entry.food]++;

                if (entry.sportsDetails) {
                    entry.sportsDetails.forEach(sport => {
                        if (sport.type === "Fuerza" && sport.group) fuerzaGroups[sport.group]++;
                        if (sport.type === "Running" && sport.km) {
                            const km = parseFloat(sport.km);
                            if (!isNaN(km)) totalRunningKm += km;
                            if (sport.pace) {
                                const parts = sport.pace.split(":");
                                if (parts.length === 2) {
                                    const sec = parseInt(parts[0]) * 60 + parseInt(parts[1]);
                                    if (!isNaN(sec)) runningPaces.push(sec);
                                }
                            }
                        }
                    });
                }
            }

            let avgPace = '-';
            if (runningPaces.length) {
                const avgSec = runningPaces.reduce((a, b) => a + b) / runningPaces.length;
                avgPace = `${Math.floor(avgSec / 60)}:${String(Math.round(avgSec % 60)).padStart(2, '0')} min/km`;
            }

            document.getElementById('summary-activities').innerHTML = `
                <p>Días registrados: ${daysRecorded} / ${totalDays}</p>
                <p>Ejercicio: ${totalExercise} | Creatina: ${totalCreatine} | Pasos: ${totalSteps}</p>
                <p>Comidas - Perfecto: ${meals.Perfecto}, Bien: ${meals.Bien}, Normal: ${meals.Normal}, Mal: ${meals.Mal}</p>
                <h4>Fuerza:</h4>
                <ul>${Object.entries(fuerzaGroups).map(([k, v]) => `<li>${k}: ${v}</li>`).join('')}</ul>
                <h4>Running:</h4>
                <p>Total km: ${totalRunningKm.toFixed(2)} | Ritmo promedio: ${avgPace}</p>
            `;

            // Chart data
            const labels = Array.from({ length: totalDays }, (_, i) => (i + 1).toString());
            const dailyExercise = [], dailyKm = [];
            let kmAccum = 0;

            for (let day = 1; day <= totalDays; day++) {
                const dateKey = getDateKey(year, month, day);
                const entry = data[dateKey] || {};
                const hasExercise = entry.exercise || entry.sportsDetails?.some(s => s.type === "Fuerza");
                dailyExercise.push(hasExercise ? 1 : 0);
                let dayKm = 0;
                entry.sportsDetails?.forEach(s => {
                    if (s.type === "Running" && !isNaN(parseFloat(s.km))) dayKm += parseFloat(s.km);
                });
                kmAccum += dayKm;
                dailyKm.push(kmAccum);
            }

            if (window.activityChartInstance) window.activityChartInstance.destroy();
            const ctx = document.getElementById('activityChart').getContext('2d');
            window.activityChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ejercicio/Fuerza',
                            data: dailyExercise,
                            backgroundColor: '#3B82F6'
                        },
                        {
                            label: 'Running acumulado (km)',
                            data: dailyKm,
                            type: 'line',
                            borderColor: '#EF4444',
                            backgroundColor: 'transparent',
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        updateCalendar();
    </script>
</html>
